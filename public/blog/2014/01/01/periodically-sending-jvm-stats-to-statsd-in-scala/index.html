
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Periodically sending JVM stats to StatsD in Scala - Parth Patil's Blog</title>
  <meta name="author" content="Parth Patil">

  
  <meta name="description" content="I have written a small library in Scala to allow periodic sending of JVM stats to StatsD server. One can include it in server written in Scala so &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://parth-patil.github.com/blog/2014/01/01/periodically-sending-jvm-stats-to-statsd-in-scala">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Parth Patil's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-4311521-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Parth Patil's Blog</a></h1>
  
    <h2>Programming, Hacks etc.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:parth-patil.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Periodically Sending JVM Stats to StatsD in Scala</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-01T15:10:00-08:00" pubdate data-updated="true">Jan 1<span>st</span>, 2014</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>I have written a small library in Scala to allow periodic sending of JVM stats to StatsD server. One can include it in server written in Scala so that its JVM stats can be monitored over time. I am using the following <a href="https://github.com/etsy/statsd/blob/master/examples/StatsD.scala">Scala class</a> to send the stats to StatsD. Also the technique to extract JVM stats is borrowed from twitter&rsquo;s excellent <a href="https://github.com/twitter/ostrich">Ostrich library</a></p>

<p>Following is the class that schedules sending of the stats periodically</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">com.parthpatil.jvmstatsd</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.collection.mutable</span>
</span><span class='line'><span class="k">import</span> <span class="nn">java.util.concurrent.</span><span class="o">{</span><span class="nc">TimeUnit</span><span class="o">,</span> <span class="nc">Executors</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">StatsSender</span><span class="o">(</span><span class="n">statsd</span><span class="k">:</span> <span class="kt">StatsD</span><span class="o">,</span> <span class="n">numSchedulerThreads</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// Tasks that need to be scheduled to send stats to statsd</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="n">tasks</span> <span class="k">=</span> <span class="n">mutable</span><span class="o">.</span><span class="nc">ArrayBuffer</span><span class="o">[(</span><span class="kt">StatsTask</span>, <span class="kt">Int</span><span class="o">)]()</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">fScheduler</span>    <span class="k">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="n">newScheduledThreadPool</span><span class="o">(</span><span class="n">numSchedulerThreads</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">addTask</span><span class="o">(</span><span class="n">task</span><span class="k">:</span> <span class="kt">StatsTask</span><span class="o">,</span> <span class="n">secs</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">task</span><span class="o">.</span><span class="n">setStatsD</span><span class="o">(</span><span class="n">statsd</span><span class="o">)</span>
</span><span class='line'>    <span class="n">tasks</span> <span class="o">+=</span> <span class="o">((</span><span class="n">task</span><span class="o">,</span> <span class="n">secs</span><span class="o">))</span>
</span><span class='line'>    <span class="n">fScheduler</span><span class="o">.</span><span class="n">scheduleWithFixedDelay</span><span class="o">(</span><span class="n">task</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">secs</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="nc">SECONDS</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">getTasks</span><span class="o">()</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[(</span><span class="kt">StatsTask</span>, <span class="kt">Int</span><span class="o">)]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">tasks</span><span class="o">.</span><span class="n">toSeq</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Following is the interface base class for a stats task that publishes stats to StatsD using the StatsD class</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">com.parthpatil.jvmstatsd</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">java.text.DecimalFormat</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">StatsTask</span><span class="o">()</span> <span class="k">extends</span> <span class="nc">Runnable</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">protected</span> <span class="k">var</span> <span class="n">statsd</span><span class="k">:</span> <span class="kt">StatsD</span> <span class="o">=</span> <span class="kc">null</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// formatter to remove scientific notation from doubles</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">formatter</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DecimalFormat</span><span class="o">(</span><span class="s">&quot;#&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">override</span> <span class="k">def</span> <span class="n">run</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">setStatsD</span><span class="o">(</span><span class="n">sd</span><span class="k">:</span> <span class="kt">StatsD</span><span class="o">)</span> <span class="o">{</span> <span class="n">statsd</span> <span class="k">=</span> <span class="n">sd</span> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Following is a sample implementation of the StatsTask that publishes JVM stats. You can write your won periodic stats publisher by extending StatsTask and adding it to StatsSender via addTask() method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">com.parthpatil.jvmstatsd</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">java.lang.management.ManagementFactory</span>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.collection.mutable</span>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.collection.JavaConverters._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">com.twitter.conversions.string._</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">JvmStatsTask</span> <span class="k">extends</span> <span class="nc">StatsTask</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">override</span> <span class="k">def</span> <span class="n">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">getJvmGauges</span><span class="o">()</span> <span class="n">foreach</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span>  <span class="k">=&gt;</span> <span class="n">statsd</span><span class="o">.</span><span class="n">gauge</span><span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">formatter</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">v</span><span class="o">))</span> <span class="o">}</span>
</span><span class='line'>    <span class="n">getJvmCounters</span><span class="o">()</span> <span class="n">foreach</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span><span class="n">v</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">statsd</span><span class="o">.</span><span class="n">increment</span><span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">getJvmGauges</span><span class="o">()</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Long</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">out</span> <span class="k">=</span> <span class="n">mutable</span><span class="o">.</span><span class="nc">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Long</span><span class="o">]()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">mem</span> <span class="k">=</span> <span class="nc">ManagementFactory</span><span class="o">.</span><span class="n">getMemoryMXBean</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">heap</span> <span class="k">=</span> <span class="n">mem</span><span class="o">.</span><span class="n">getHeapMemoryUsage</span><span class="o">()</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.heap.committed&quot;</span> <span class="o">-&gt;</span> <span class="n">heap</span><span class="o">.</span><span class="n">getCommitted</span><span class="o">())</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.heap.max&quot;</span> <span class="o">-&gt;</span> <span class="n">heap</span><span class="o">.</span><span class="n">getMax</span><span class="o">())</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.heap.used&quot;</span> <span class="o">-&gt;</span> <span class="n">heap</span><span class="o">.</span><span class="n">getUsed</span><span class="o">())</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">nonheap</span> <span class="k">=</span> <span class="n">mem</span><span class="o">.</span><span class="n">getNonHeapMemoryUsage</span><span class="o">()</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.nonheap.committed&quot;</span> <span class="o">-&gt;</span> <span class="n">nonheap</span><span class="o">.</span><span class="n">getCommitted</span><span class="o">())</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.nonheap.max&quot;</span> <span class="o">-&gt;</span> <span class="n">nonheap</span><span class="o">.</span><span class="n">getMax</span><span class="o">())</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.nonheap.used&quot;</span> <span class="o">-&gt;</span> <span class="n">nonheap</span><span class="o">.</span><span class="n">getUsed</span><span class="o">())</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">threads</span> <span class="k">=</span> <span class="nc">ManagementFactory</span><span class="o">.</span><span class="n">getThreadMXBean</span><span class="o">()</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.thread.daemon_count&quot;</span> <span class="o">-&gt;</span> <span class="n">threads</span><span class="o">.</span><span class="n">getDaemonThreadCount</span><span class="o">().</span><span class="n">toLong</span><span class="o">)</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.thread.count&quot;</span> <span class="o">-&gt;</span> <span class="n">threads</span><span class="o">.</span><span class="n">getThreadCount</span><span class="o">().</span><span class="n">toLong</span><span class="o">)</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.thread.peak_count&quot;</span> <span class="o">-&gt;</span> <span class="n">threads</span><span class="o">.</span><span class="n">getPeakThreadCount</span><span class="o">().</span><span class="n">toLong</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">runtime</span> <span class="k">=</span> <span class="nc">ManagementFactory</span><span class="o">.</span><span class="n">getRuntimeMXBean</span><span class="o">()</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.start_time&quot;</span> <span class="o">-&gt;</span> <span class="n">runtime</span><span class="o">.</span><span class="n">getStartTime</span><span class="o">())</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.uptime&quot;</span> <span class="o">-&gt;</span> <span class="n">runtime</span><span class="o">.</span><span class="n">getUptime</span><span class="o">())</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">os</span> <span class="k">=</span> <span class="nc">ManagementFactory</span><span class="o">.</span><span class="n">getOperatingSystemMXBean</span><span class="o">()</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.num_cpus&quot;</span> <span class="o">-&gt;</span> <span class="n">os</span><span class="o">.</span><span class="n">getAvailableProcessors</span><span class="o">().</span><span class="n">toLong</span><span class="o">)</span>
</span><span class='line'>    <span class="n">os</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="n">unix</span><span class="k">:</span> <span class="kt">com.sun.management.UnixOperatingSystemMXBean</span> <span class="o">=&gt;</span>
</span><span class='line'>        <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.fd.count&quot;</span> <span class="o">-&gt;</span> <span class="n">unix</span><span class="o">.</span><span class="n">getOpenFileDescriptorCount</span><span class="o">)</span>
</span><span class='line'>        <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.fd.limit&quot;</span> <span class="o">-&gt;</span> <span class="n">unix</span><span class="o">.</span><span class="n">getMaxFileDescriptorCount</span><span class="o">)</span>
</span><span class='line'>      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>   <span class="c1">// ew, Windows... or something</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="n">postGCTotalUsage</span> <span class="k">=</span> <span class="mi">0L</span>
</span><span class='line'>    <span class="k">var</span> <span class="n">currentTotalUsage</span> <span class="k">=</span> <span class="mi">0L</span>
</span><span class='line'>    <span class="nc">ManagementFactory</span><span class="o">.</span><span class="n">getMemoryPoolMXBeans</span><span class="o">().</span><span class="n">asScala</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span> <span class="n">pool</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">getName</span><span class="o">.</span><span class="n">regexSub</span><span class="o">(</span><span class="s">&quot;&quot;&quot;[^\w]&quot;&quot;&quot;</span><span class="o">.</span><span class="n">r</span><span class="o">)</span> <span class="o">{</span> <span class="n">m</span> <span class="k">=&gt;</span> <span class="s">&quot;.&quot;</span> <span class="o">}</span>
</span><span class='line'>      <span class="nc">Option</span><span class="o">(</span><span class="n">pool</span><span class="o">.</span><span class="n">getCollectionUsage</span><span class="o">).</span><span class="n">foreach</span> <span class="o">{</span> <span class="n">usage</span> <span class="k">=&gt;</span>
</span><span class='line'>        <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.post_gc.&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;.used&quot;</span> <span class="o">-&gt;</span> <span class="n">usage</span><span class="o">.</span><span class="n">getUsed</span><span class="o">)</span>
</span><span class='line'>        <span class="n">postGCTotalUsage</span> <span class="o">+=</span> <span class="n">usage</span><span class="o">.</span><span class="n">getUsed</span>
</span><span class='line'>        <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.post_gc.&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;.max&quot;</span> <span class="o">-&gt;</span> <span class="n">usage</span><span class="o">.</span><span class="n">getMax</span><span class="o">)</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="nc">Option</span><span class="o">(</span><span class="n">pool</span><span class="o">.</span><span class="n">getUsage</span><span class="o">)</span> <span class="n">foreach</span> <span class="o">{</span> <span class="n">usage</span> <span class="k">=&gt;</span>
</span><span class='line'>        <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.current_mem.&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;.used&quot;</span> <span class="o">-&gt;</span> <span class="n">usage</span><span class="o">.</span><span class="n">getUsed</span><span class="o">)</span>
</span><span class='line'>        <span class="n">currentTotalUsage</span> <span class="o">+=</span> <span class="n">usage</span><span class="o">.</span><span class="n">getUsed</span>
</span><span class='line'>        <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.current_mem.&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;.max&quot;</span> <span class="o">-&gt;</span> <span class="n">usage</span><span class="o">.</span><span class="n">getMax</span><span class="o">)</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.post_gc.used&quot;</span> <span class="o">-&gt;</span> <span class="n">postGCTotalUsage</span><span class="o">)</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.current_mem.used&quot;</span> <span class="o">-&gt;</span> <span class="n">currentTotalUsage</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">out</span><span class="o">.</span><span class="n">toMap</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">getJvmCounters</span><span class="o">()</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Long</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">out</span> <span class="k">=</span> <span class="n">mutable</span><span class="o">.</span><span class="nc">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Long</span><span class="o">]()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="n">totalCycles</span> <span class="k">=</span> <span class="mi">0L</span>
</span><span class='line'>    <span class="k">var</span> <span class="n">totalTime</span> <span class="k">=</span> <span class="mi">0L</span>
</span><span class='line'>
</span><span class='line'>    <span class="nc">ManagementFactory</span><span class="o">.</span><span class="n">getGarbageCollectorMXBeans</span><span class="o">().</span><span class="n">asScala</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span> <span class="n">gc</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">getName</span><span class="o">.</span><span class="n">regexSub</span><span class="o">(</span><span class="s">&quot;&quot;&quot;[^\w]&quot;&quot;&quot;</span><span class="o">.</span><span class="n">r</span><span class="o">)</span> <span class="o">{</span> <span class="n">m</span> <span class="k">=&gt;</span> <span class="s">&quot;.&quot;</span> <span class="o">}</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">collectionCount</span> <span class="k">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">getCollectionCount</span>
</span><span class='line'>      <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.gc.&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;.cycles&quot;</span> <span class="o">-&gt;</span> <span class="n">collectionCount</span><span class="o">)</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">collectionTime</span> <span class="k">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">getCollectionTime</span>
</span><span class='line'>      <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.gc.&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;.msec&quot;</span> <span class="o">-&gt;</span> <span class="n">collectionTime</span><span class="o">)</span>
</span><span class='line'>      <span class="c1">// note, these could be -1 if the collector doesn&#39;t have support for it.</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">collectionCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'>        <span class="n">totalCycles</span> <span class="o">+=</span> <span class="n">collectionCount</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">collectionTime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'>        <span class="n">totalTime</span> <span class="o">+=</span> <span class="n">gc</span><span class="o">.</span><span class="n">getCollectionTime</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.gc.cycles&quot;</span> <span class="o">-&gt;</span> <span class="n">totalCycles</span><span class="o">)</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">+=</span> <span class="o">(</span><span class="s">&quot;jvm.gc.msec&quot;</span> <span class="o">-&gt;</span> <span class="n">totalTime</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">out</span><span class="o">.</span><span class="n">toMap</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sample Usage</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">com.parthpatil.jvmstatsd</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.actor.ActorSystem</span>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">SampleUsage</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">actorSystem</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="s">&quot;statsd-actor-system&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">statsD</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StatsD</span><span class="o">(</span>
</span><span class='line'>      <span class="n">context</span> <span class="k">=</span> <span class="n">actorSystem</span><span class="o">,</span>
</span><span class='line'>      <span class="n">host</span> <span class="k">=</span> <span class="s">&quot;localhost&quot;</span><span class="o">,</span>
</span><span class='line'>      <span class="n">port</span> <span class="k">=</span> <span class="mi">8192</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">statsSender</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StatsSender</span><span class="o">(</span><span class="n">statsD</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Create the JvmStatsTask that publishes stats every 10 secs</span>
</span><span class='line'>    <span class="n">statsSender</span><span class="o">.</span><span class="n">addTask</span><span class="o">(</span><span class="n">task</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">JvmStatsTask</span><span class="o">,</span> <span class="n">secs</span> <span class="k">=</span> <span class="mi">10</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can find the full source in this <a href="https://github.com/parth-patil/JvmStatsD">repo</a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Parth Patil</span></span>

      








  


<time datetime="2014-01-01T15:10:00-08:00" pubdate data-updated="true">Jan 1<span>st</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/akka/'>akka</a>, <a class='category' href='/blog/categories/scala/'>scala</a>, <a class='category' href='/blog/categories/stats/'>stats</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://parth-patil.github.com/blog/2014/01/01/periodically-sending-jvm-stats-to-statsd-in-scala/" data-via="" data-counturl="http://parth-patil.github.com/blog/2014/01/01/periodically-sending-jvm-stats-to-statsd-in-scala/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/03/21/using-bitsets-for-user-analytics/" title="Previous Post: Using BitSets for User Analytics">&laquo; Using BitSets for User Analytics</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/01/01/periodically-sending-jvm-stats-to-statsd-in-scala/">Periodically sending JVM stats to StatsD in Scala</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/21/using-bitsets-for-user-analytics/">Using BitSets for User Analytics</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/18/implementing-iterator-design-pattern-in-scala/">Implementing Iterator Design Pattern in Scala</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/10/custom-functions-in-hbase-shell/">Custom functions in HBase shell</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/09/group-anagram-puzzle-in-various-programming-languages/">Group Anagram puzzle in various programming languages</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Parth Patil -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'parth-patils-blog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://parth-patil.github.com/blog/2014/01/01/periodically-sending-jvm-stats-to-statsd-in-scala/';
        var disqus_url = 'http://parth-patil.github.com/blog/2014/01/01/periodically-sending-jvm-stats-to-statsd-in-scala/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
